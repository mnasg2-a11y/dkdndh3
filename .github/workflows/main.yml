name: Persistent-VPS
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'  # ูุนูุฏ ุชุดุบูู ููุณู ูู 5 ุณุงุนุงุช (ูุจู ุงูุชูุงุก ุงูู6 ุณุงุนุงุช)

jobs:
  secure-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 0
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Restore Data
        run: |
          git config --global user.name "VPS-Bot"
          git config --global user.email "bot@vps.com"
          mkdir -p ~/my_data
          echo "โ ุชู ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช"

      - name: Install & Configure SSH
        run: |
          sudo apt update -y
          sudo apt install -y openssh-server curl wget
          sudo systemctl enable ssh
          sudo systemctl start ssh
          
          # ุฅูุดุงุก ูุณุชุฎุฏู SSH
          echo "root:GitHubVPS2024!" | sudo chpasswd
          
          # ุฅุนุฏุงุฏุงุช SSH ุซุงุจุชุฉ
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          echo "ClientAliveInterval 60" | sudo tee -a /etc/ssh/sshd_config
          echo "ClientAliveCountMax 120" | sudo tee -a /etc/ssh/sshd_config
          
          sudo systemctl restart ssh
          echo "โ SSH ุฌุงูุฒ: root@[IP] | ูููุฉ ุงููุฑูุฑ: GitHubVPS2024!"

      - name: Install Tailscale with Persistent Config
        run: |
          # ุชุซุจูุช Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # ุญูุธ ุงูู Auth Key ูู ููู ูุญูู
          echo "TAILSCALE_AUTH_KEY=${{ secrets.TAILSCALE_AUTH_KEY }}" | sudo tee /etc/tailscale/auth_key.env
          sudo chmod 600 /etc/tailscale/auth_key.env
          
          # ุงุณุชุฎุฏุงู ููุณ ุงูุงุณู ูุงูุนููุงู ุฏุงุฆูุงู
          sudo tailscale up \
            --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" \
            --hostname="persistent-vps-$(hostname -s)" \
            --advertise-exit-node \
            --accept-dns=false \
            --accept-routes \
            --reset
          
          # ุงูุชุธุงุฑ ุงูุญุตูู ุนูู IP
          sleep 10
          
          # ุงูุญุตูู ุนูู IP ูุนุฑุถู
          TS_IP=$(tailscale ip -4 | head -n 1)
          echo "PERSISTENT_IP=$TS_IP" | sudo tee /etc/tailscale/ip.conf
          echo "โ Tailscale IP ุซุงุจุช: $TS_IP"
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          
          # ุฅูุดุงุก ููู ูุญูุธ IP ุงูุณุงุจู
          echo "PREVIOUS_IP=$TS_IP" | sudo tee /tmp/previous_ip.txt
          
          # ุนุฑุถ ูุนูููุงุช ุงูุงุชุตุงู
          echo "========================================="
          echo "๐ ุฅุนุฏุงุฏุงุช Tailscale ุงูุซุงุจุชุฉ:"
          echo "โ ุงููุถูู: persistent-vps-$(hostname -s)"
          echo "๐ IP ุงูุญุงูู: $TS_IP"
          echo "๐ ุชู ุงูุฑุจุท ุจุงุณุชุฎุฏุงู AuthKey"
          echo "========================================="

      - name: Create Auto-Reconnect Service
        run: |
          # ุฅูุดุงุก ุณูุฑูุจุช ุฅุนุงุฏุฉ ุงูุงุชุตุงู
          cat << 'EOF' | sudo tee /usr/local/bin/tailscale-autoreconnect.sh
          #!/bin/bash
          # ุณูุฑูุจุช ุฅุนุงุฏุฉ ุงูุงุชุตุงู ุจู Tailscale
          
          # ุชุญููู ุงูู Auth Key
          if [ -f /etc/tailscale/auth_key.env ]; then
              source /etc/tailscale/auth_key.env
          else
              echo "โ ูู ูุชู ุงูุนุซูุฑ ุนูู ููุชุงุญ ุงููุตุงุฏูุฉ"
              exit 1
          fi
          
          while true; do
              # ุงูุชุญูู ูู ุงุชุตุงู Tailscale ูู ุฏูููุฉ
              if ! tailscale status 2>/dev/null | grep -q "active"; then
                  echo "๐ ุฅุนุงุฏุฉ ุงูุงุชุตุงู ุจู Tailscale..."
                  
                  # ูุญุงููุฉ ุงุณุชุฎุฏุงู IP ุงูุณุงุจู
                  if [ -f /tmp/last_ip_saved.txt ]; then
                      source /tmp/last_ip_saved.txt
                      echo "๐ ูุญุงููุฉ ุงุณุชุฎุฏุงู IP ุงูุณุงุจู: $LAST_IP"
                  fi
                  
                  sudo tailscale up \
                    --authkey="$TAILSCALE_AUTH_KEY" \
                    --hostname="persistent-vps-$(hostname -s)" \
                    --advertise-exit-node \
                    --accept-dns=false \
                    --accept-routes \
                    --reset
                  
                  sleep 10
                  NEW_IP=$(tailscale ip -4 | head -n 1)
                  echo "โ ุชูุช ุฅุนุงุฏุฉ ุงูุงุชุตุงู - IP ุฌุฏูุฏ: $NEW_IP"
                  
                  # ุญูุธ IP ุงูุฌุฏูุฏ
                  echo "LAST_IP=$NEW_IP" | sudo tee /tmp/last_ip_saved.txt
              fi
              sleep 60
          done
          EOF
          
          sudo chmod +x /usr/local/bin/tailscale-autoreconnect.sh
          
          # ุฅูุดุงุก ุฎุฏูุฉ systemd
          cat << EOF | sudo tee /etc/systemd/system/tailscale-autoreconnect.service
          [Unit]
          Description=Tailscale Auto-Reconnect Service
          After=network.target tailscale.service
          Wants=tailscale.service
          Requires=tailscale.service
          
          [Service]
          Type=simple
          ExecStart=/usr/local/bin/tailscale-autoreconnect.sh
          Restart=always
          RestartSec=10
          User=root
          Environment="PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          sudo systemctl daemon-reload
          sudo systemctl enable tailscale-autoreconnect.service
          sudo systemctl start tailscale-autoreconnect.service
          echo "โ ุชู ุฅูุดุงุก ุฎุฏูุฉ ุฅุนุงุฏุฉ ุงูุงุชุตุงู ุงูุชููุงุฆู"

      - name: Setup Early Session Renewal
        run: |
          # ุณูุฑูุจุช ูุชุฌุฏูุฏ ุงูุฌูุณุฉ ูุจู ุณุงุนุฉ ูู ุงูุชูุงุฆูุง
          cat << 'EOF' | sudo tee /usr/local/bin/renew_session.sh
          #!/bin/bash
          # ุณูุฑูุจุช ุชุฌุฏูุฏ ุงูุฌูุณุฉ - ูุนูู ูุจู ุณุงุนุฉ ูู ุงูุชูุงุก ุงูููุช
          
          # ุชุญููู ุงูู Auth Key
          if [ -f /etc/tailscale/auth_key.env ]; then
              source /etc/tailscale/auth_key.env
          fi
          
          # ููุช ุจุฏุก ุงูุฌูุณุฉ
          SESSION_START=$(date +%s)
          # ูุฏุฉ ุงูุฌูุณุฉ (5 ุณุงุนุงุช - 1 ุณุงุนุฉ = 4 ุณุงุนุงุช)
          SESSION_DURATION=14400  # 4 ุณุงุนุงุช * 3600 ุซุงููุฉ
          RENEW_EARLY=3600        # ุณุงุนุฉ ูุงุญุฏุฉ ูุจู ุงูุงูุชูุงุก
          
          echo "โฐ ุจุฏุก ูุฑุงูุจุฉ ุชุฌุฏูุฏ ุงูุฌูุณุฉ..."
          echo "   ููุช ุงูุจุฏุก: $(date -d @$SESSION_START)"
          echo "   ุณููุชูู ูู: $(date -d @$(($SESSION_START + $SESSION_DURATION)))"
          echo "   ุณูุชู ุงูุชุฌุฏูุฏ ูู: $(date -d @$(($SESSION_START + $SESSION_DURATION - $RENEW_EARLY)))"
          
          while true; do
            CURRENT_TIME=$(date +%s)
            TIME_ELAPSED=$((CURRENT_TIME - SESSION_START))
            TIME_REMAINING=$((SESSION_DURATION - TIME_ELAPSED))
            
            if [ $TIME_REMAINING -le $RENEW_EARLY ] && [ $TIME_REMAINING -gt 0 ]; then
              echo "๐ ุญุงู ููุช ุชุฌุฏูุฏ ุงูุฌูุณุฉ (ูุชุจูู: $TIME_REMAINING ุซุงููุฉ)"
              
              # ุญูุธ IP ุงูุญุงูู
              CURRENT_IP=$(tailscale ip -4 | head -n 1)
              echo "๐พ ุญูุธ IP ุงูุญุงูู: $CURRENT_IP"
              echo "LAST_IP=$CURRENT_IP" | sudo tee /tmp/last_ip_saved.txt
              
              # ุฅุนุงุฏุฉ ุชุดุบูู Tailscale
              echo "๐ ุฅุนุงุฏุฉ ุชุดุบูู Tailscale..."
              sudo tailscale up \
                --authkey="$TAILSCALE_AUTH_KEY" \
                --hostname="persistent-vps-$(hostname -s)" \
                --advertise-exit-node \
                --accept-dns=false \
                --reset
              
              echo "๐ข ุชู ุชุฌุฏูุฏ ุงูุฌูุณุฉ ุจูุฌุงุญ"
              
              # ุฅุนุงุฏุฉ ุถุจุท ููุช ุงูุจุฏุก
              SESSION_START=$(date +%s)
            fi
            
            # ุนุฑุถ ุงูููุช ุงููุชุจูู ูู 5 ุฏูุงุฆู
            if [ $((TIME_ELAPSED % 300)) -eq 0 ]; then
              MINUTES_REMAINING=$((TIME_REMAINING / 60))
              echo "โณ ุงูููุช ุงููุชุจูู ููุฌูุณุฉ: $MINUTES_REMAINING ุฏูููุฉ"
            fi
            
            sleep 60
          done
          EOF
          
          sudo chmod +x /usr/local/bin/renew_session.sh
          
          # ุฅูุดุงุก ุฎุฏูุฉ systemd
          cat << EOF | sudo tee /etc/systemd/system/renew-session.service
          [Unit]
          Description=Session Renewal Service
          After=tailscale.service
          Wants=tailscale.service
          
          [Service]
          Type=simple
          ExecStart=/usr/local/bin/renew_session.sh
          Restart=always
          RestartSec=10
          User=root
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          sudo systemctl daemon-reload
          sudo systemctl enable renew-session.service
          sudo systemctl start renew-session.service
          
          echo "โ ุชู ุฅุนุฏุงุฏ ูุธุงู ุชุฌุฏูุฏ ุงูุฌูุณุงุช ุงูุชููุงุฆู"

      - name: Create Persistent IP Service
        run: |
          # ุฅูุดุงุก ุณูุฑูุจุช ููุญูุงุธ ุนูู IP
          cat << 'EOF' | sudo tee /usr/local/bin/persistent-ip.sh
          #!/bin/bash
          # ุณูุฑูุจุช ููุญูุงุธ ุนูู ููุณ IP
          
          # ุชุญููู ุงูู Auth Key
          if [ -f /etc/tailscale/auth_key.env ]; then
              source /etc/tailscale/auth_key.env
          fi
          
          echo "๐ ุจุฏุก ุฎุฏูุฉ ุงูุญูุงุธ ุนูู IP ุงูุซุงุจุช"
          
          # ูุญุงููุฉ ุงุณุชุฎุฏุงู IP ุงูุณุงุจู ุฅุฐุง ูุงู ููุฌูุฏุงู
          if [ -f /tmp/last_ip_saved.txt ]; then
            source /tmp/last_ip_saved.txt
            echo "๐ ุงูุจุญุซ ุนู IP ุงูุณุงุจู: $LAST_IP"
          fi
          
          while true; do
            # ุงูุญุตูู ุนูู IP ุงูุญุงูู
            CURRENT_IP=$(tailscale ip -4 | head -n 1)
            
            if [ -z "$CURRENT_IP" ]; then
              echo "โ ูุง ููุฌุฏ ุงุชุตุงู ุจู Tailscaleุ ุฅุนุงุฏุฉ ุงููุญุงููุฉ..."
              sudo tailscale up \
                --authkey="$TAILSCALE_AUTH_KEY" \
                --hostname="persistent-vps-$(hostname -s)" \
                --advertise-exit-node \
                --accept-dns=false \
                --reset
              sleep 10
              continue
            fi
            
            # ุนุฑุถ ุญุงูุฉ IP
            echo "๐ IP ุงูุญุงูู: $CURRENT_IP | ุงูููุช: $(date)"
            
            # ููุงุฑูุฉ ูุน IP ุงูุณุงุจู
            if [ -n "$LAST_IP" ] && [ "$CURRENT_IP" != "$LAST_IP" ]; then
              echo "โ๏ธ ุชุบููุฑ ูู IP: $LAST_IP โ $CURRENT_IP"
            fi
            
            # ุญูุธ IP ุงูุญุงูู ูุณุงุจู
            echo "LAST_IP=$CURRENT_IP" | sudo tee /tmp/last_ip_saved.txt
            
            sleep 300  # ูู 5 ุฏูุงุฆู
          done
          EOF
          
          sudo chmod +x /usr/local/bin/persistent-ip.sh
          
          # ุฅูุดุงุก ุฎุฏูุฉ systemd
          cat << EOF | sudo tee /etc/systemd/system/persistent-ip.service
          [Unit]
          Description=Persistent IP Service
          After=tailscale.service
          Wants=tailscale.service
          
          [Service]
          Type=simple
          ExecStart=/usr/local/bin/persistent-ip.sh
          Restart=always
          RestartSec=10
          User=root
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          sudo systemctl daemon-reload
          sudo systemctl enable persistent-ip.service
          sudo systemctl start persistent-ip.service
          
          echo "โ ุชู ุฅูุดุงุก ุฎุฏูุฉ IP ุงูุซุงุจุชุฉ"

      - name: Keep VPS Alive with Same IP Forever
        run: |
          echo "========================================="
          echo "๐ VPS ุฏุงุฆู ุจู IP ุซุงุจุช!"
          echo "========================================="
          
          # ุงูุญุตูู ุนูู IP ุงูุญุงูู
          CURRENT_IP=$(tailscale ip -4 | head -n 1)
          
          echo "๐ *ูุนูููุงุช ุงูุงุชุตุงู ุงูุซุงุจุชุฉ:*"
          echo "๐ IP ุงูุญุงูู: $CURRENT_IP"
          echo "๐ก ุณูุจูู ูุฐุง IP ููุง ูู ูุฏุฑ ุงูุฅููุงู"
          echo "๐ฅ๏ธ  SSH: ssh root@$CURRENT_IP"
          echo "๐ Password: GitHubVPS2024!"
          echo ""
          echo "โ๏ธ *ุงููููุฒุงุช ุงููุถููุฉ:*"
          echo "โ ุฅุนุงุฏุฉ ุงุชุตุงู ุชููุงุฆู ุจู Tailscale"
          echo "โ ุชุฌุฏูุฏ ุงูุฌูุณุฉ ูุจู ุณุงุนุฉ ูู ุงูุชูุงุฆูุง"
          echo "โ ูุญุงููุฉ ุงูุญูุงุธ ุนูู ููุณ IP"
          echo "โ ูุฑุงูุจุฉ ูุณุชูุฑุฉ ููุญุงูุฉ"
          echo ""
          echo "๐ง *ุงูุฌุฏุงูู ุงูุฒูููุฉ:*"
          echo "โฐ ุฅุนุงุฏุฉ ุงูุชุดุบูู ุงูุชููุงุฆู: ูู 5 ุณุงุนุงุช"
          echo "๐ ุชุฌุฏูุฏ ุงูุฌูุณุฉ: ูุจู ุณุงุนุฉ ูู ุงูุงูุชูุงุก"
          echo "๐ก ูุญุต ุงูุงุชุตุงู: ูู ุฏูููุฉ"
          echo ""
          echo "๐ *ููุงุชุตุงู ุงูุขู:*"
          echo "ssh root@$CURRENT_IP"
          echo "ูููุฉ ุงููุฑูุฑ: GitHubVPS2024!"
          echo ""
          echo "[$(date)] ุจุฏุก ุงูุชุดุบูู ุงูุฏุงุฆู..."
          
          # ุญูุธ ูุนูููุงุช ุงูุงุชุตุงู ูู ููู
          cat << EOF > /tmp/connection_info.txt
          =========================================
          ุงุชุตุงู VPS ุงูุฏุงุฆู
          =========================================
          IP: $CURRENT_IP
          SSH: ssh root@$CURRENT_IP
          Password: GitHubVPS2024!
          Start Time: $(date)
          Features:
          - Auto-reconnect to Tailscale
          - Session renewal 1 hour before end
          - Persistent IP maintenance
          =========================================
          EOF
          
          echo "๐พ ุชู ุญูุธ ูุนูููุงุช ุงูุงุชุตุงู ูู /tmp/connection_info.txt"
          
          # ุนุฑุถ ุญุงูุฉ ุงูุฎุฏูุงุช
          echo ""
          echo "๐ ุญุงูุฉ ุงูุฎุฏูุงุช:"
          echo "   SSH: $(sudo systemctl is-active ssh)"
          echo "   Tailscale: $(tailscale status | head -1 | awk '{print $1}' 2>/dev/null || echo 'inactive')"
          echo "   Auto-Reconnect: $(sudo systemctl is-active tailscale-autoreconnect.service)"
          echo "   Session Renewal: $(sudo systemctl is-active renew-session.service)"
          echo "   Persistent IP: $(sudo systemctl is-active persistent-ip.service)"
          
          # ุญููุฉ ุงูุนุฑุถ ุงูุฑุฆูุณูุฉ
          counter=1
          while true; do
            echo ""
            echo "========================================="
            echo "๐ [$(date)] - ุงูุณุงุนุฉ $counter ูู ุงูุชุดุบูู"
            echo "========================================="
            
            # ุนุฑุถ IP ุงูุญุงูู
            CURRENT_IP=$(tailscale ip -4 | head -n 1)
            echo "๐ IP ุงูุญุงูู: $CURRENT_IP"
            echo "๐ SSH: ssh root@$CURRENT_IP"
            echo "๐ Password: GitHubVPS2024!"
            
            # ุนุฑุถ ุญุงูุฉ ุงูุฎุฏูุงุช ูู 6 ุณุงุนุงุช
            if (( counter % 6 == 0 )); then
              echo ""
              echo "๐ ูุญุต ุญุงูุฉ ุงูุฎุฏูุงุช:"
              sudo systemctl status tailscale-autoreconnect.service --no-pager -l | head -20
              echo ""
              sudo systemctl status persistent-ip.service --no-pager -l | head -20
            fi
            
            # ุนุฑุถ ุงุณุชุฎุฏุงู ุงููุธุงู ูู 12 ุณุงุนุฉ
            if (( counter % 12 == 0 )); then
              echo ""
              echo "๐ ูุญุต ุงููุธุงู:"
              echo "   ุงูุฐุงูุฑุฉ: $(free -h | grep Mem | awk '{print $3"/"$2 " (" $4 " free)"}')"
              echo "   ุงููุนุงูุฌ: $(top -bn1 | grep "Cpu(s)" | awk '{print $2 "% used"}' 2>/dev/null || echo 'N/A')"
              echo "   ุงูุชุฎุฒูู: $(df -h / | tail -1 | awk '{print $3"/"$2 " (" $5 " used)"}')"
              echo "   ููุช ุงูุชุดุบูู: $(uptime -p)"
            fi
            
            # ุงูููู ููุฏุฉ ุณุงุนุฉ
            sleep 3600
            counter=$((counter + 1))
            
            # ุชูุธูู ูุฅุนุงุฏุฉ ุชุดุบูู ุฏูุฑู ูู 24 ุณุงุนุฉ
            if (( counter % 24 == 0 )); then
              echo ""
              echo "๐งน ุชูุธูู ูุตูุงูุฉ ุฏูุฑูุฉ..."
              sudo systemctl restart ssh
              echo "โ ุชูุช ุตูุงูุฉ ุงููุธุงู"
            fi
          done
