name: Persistent-VPS
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'  # ูุนูุฏ ุชุดุบูู ููุณู ูู 5 ุณุงุนุงุช

jobs:
  secure-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Restore Data
        run: |
          git config --global user.name "VPS-Bot"
          git config --global user.email "bot@vps.com"
          mkdir -p ~/my_data
          echo "โ ุชู ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช"

      - name: Install & Configure SSH
        run: |
          sudo apt update -y
          sudo apt install -y openssh-server curl wget
          sudo systemctl enable ssh
          sudo systemctl start ssh
          
          # ุฅูุดุงุก ูุณุชุฎุฏู SSH
          echo "root:GitHubVPS2024!" | sudo chpasswd
          
          # ุฅุนุฏุงุฏุงุช SSH ุซุงุจุชุฉ
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          echo "ClientAliveInterval 60" | sudo tee -a /etc/ssh/sshd_config
          echo "ClientAliveCountMax 120" | sudo tee -a /etc/ssh/sshd_config
          
          sudo systemctl restart ssh
          echo "โ SSH ุฌุงูุฒ: root@[IP] | ูููุฉ ุงููุฑูุฑ: GitHubVPS2024!"

      - name: Install Tailscale
        run: |
          # ุชุซุจูุช Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # ุชุดุบูู Tailscale
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="persistent-vps-${{ github.run_id }}" --reset
          
          # ุงูุชุธุงุฑ ุงูุญุตูู ุนูู IP
          sleep 5
          
          # ุงูุญุตูู ุนูู IP
          tsIP=$(tailscale ip -4 | head -n 1)
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          
          echo "========================================="
          echo "โ Tailscale ุฌุงูุฒ!"
          echo "๐ IP: $tsIP"
          echo "๐ฅ๏ธ  SSH: ssh root@$tsIP"
          echo "๐ Password: GitHubVPS2024!"
          echo "========================================="

      - name: Setup Auto-Reconnect Script
        run: |
          # ุฅูุดุงุก ุณูุฑูุจุช ุจุณูุท ูุฅุนุงุฏุฉ ุงูุงุชุตุงู
          cat << 'EOF' > /tmp/autoreconnect.sh
          #!/bin/bash
          echo "๐ง ุจุฏุก ุณูุฑูุจุช ุฅุนุงุฏุฉ ุงูุงุชุตุงู ุงูุชููุงุฆู..."
          
          while true; do
            # ุงูุชุญูู ูู ุงุชุตุงู Tailscale
            if ! tailscale status 2>/dev/null | grep -q "active"; then
              echo "๐ ุฅุนุงุฏุฉ ุงูุงุชุตุงู ุจู Tailscale..."
              sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="persistent-vps-${{ github.run_id }}" --reset
              sleep 5
              NEW_IP=$(tailscale ip -4 | head -n 1)
              echo "โ ุชูุช ุฅุนุงุฏุฉ ุงูุงุชุตุงู - IP: $NEW_IP"
            fi
            
            # ุนุฑุถ ุญุงูุฉ ุงูุงุชุตุงู ูู 5 ุฏูุงุฆู
            IP=$(tailscale ip -4 | head -n 1 2>/dev/null || echo "ุบูุฑ ูุชุตู")
            echo "๐ ุญุงูุฉ ุงูุงุชุตุงู: $IP - ุงูููุช: $(date)"
            
            sleep 300  # ุงูุชุธุงุฑ 5 ุฏูุงุฆู
          done
          EOF
          
          chmod +x /tmp/autoreconnect.sh
          
          # ุชุดุบูู ุงูุณูุฑูุจุช ูู ุงูุฎูููุฉ
          /tmp/autoreconnect.sh &
          echo "โ ุชู ุชุดุบูู ุณูุฑูุจุช ุฅุนุงุฏุฉ ุงูุงุชุตุงู"

      - name: Setup Auto-Save Script
        run: |
          # ุฅูุดุงุก ุณูุฑูุจุช ูุญูุธ ุงูุจูุงูุงุช
          cat << 'EOF' > /tmp/autosave.sh
          #!/bin/bash
          echo "๐พ ุจุฏุก ุณูุฑูุจุช ุงูุญูุธ ุงูุชููุงุฆู..."
          
          counter=1
          while true; do
            # ุญูุธ ูุนูููุงุช ุงูุงุชุตุงู ูู 30 ุฏูููุฉ
            if [ $((counter % 6)) -eq 0 ]; then
              IP=$(tailscale ip -4 | head -n 1 2>/dev/null || echo "ุบูุฑ ูุชุตู")
              echo "๐พ ุญูุธ ุงูุจูุงูุงุช (ุงูุฏูุฑุฉ: $counter)"
              echo "=========================================" > /tmp/vps_status.txt
              echo "VPS Status - $(date)" >> /tmp/vps_status.txt
              echo "IP: $IP" >> /tmp/vps_status.txt
              echo "SSH: ssh root@$IP" >> /tmp/vps_status.txt
              echo "Password: GitHubVPS2024!" >> /tmp/vps_status.txt
              echo "Uptime: $((counter * 5)) ุฏูููุฉ" >> /tmp/vps_status.txt
              echo "=========================================" >> /tmp/vps_status.txt
            fi
            
            counter=$((counter + 1))
            sleep 300  # ุงูุชุธุงุฑ 5 ุฏูุงุฆู
          done
          EOF
          
          chmod +x /tmp/autosave.sh
          
          # ุชุดุบูู ุงูุณูุฑูุจุช ูู ุงูุฎูููุฉ
          /tmp/autosave.sh &
          echo "โ ุชู ุชุดุบูู ุณูุฑูุจุช ุงูุญูุธ ุงูุชููุงุฆู"

      - name: Keep VPS Alive Forever
        run: |
          echo "========================================="
          echo "๐ VPS ุฏุงุฆู ูุนูู!"
          echo "========================================="
          
          # ุงูุญุตูู ุนูู IP ุงูุญุงูู
          CURRENT_IP=$(tailscale ip -4 | head -n 1)
          
          if [ -z "$CURRENT_IP" ]; then
            CURRENT_IP="ูู ุงูุชุธุงุฑ ุงูุงุชุตุงู..."
          fi
          
          echo "๐ *ูุนูููุงุช ุงูุงุชุตุงู:*"
          echo "๐ IP: $CURRENT_IP"
          echo "๐ฅ๏ธ  SSH: ssh root@$CURRENT_IP"
          echo "๐ Password: GitHubVPS2024!"
          echo ""
          echo "โ๏ธ *ุงููููุฒุงุช ุงููุถููุฉ:*"
          echo "โ ุฅุนุงุฏุฉ ุงุชุตุงู ุชููุงุฆู ุจู Tailscale"
          echo "โ ุญูุธ ุจูุงูุงุช ุชููุงุฆู ูู 30 ุฏูููุฉ"
          echo "โ SSH ุฌุงูุฒ ููุงุณุชุฎุฏุงู"
          echo "โ ูุฑุงูุจุฉ ูุณุชูุฑุฉ ููุญุงูุฉ"
          echo ""
          echo "๐ *ููุงุชุตุงู ุงูุขู:*"
          echo "ssh root@$CURRENT_IP"
          echo "ูููุฉ ุงููุฑูุฑ: GitHubVPS2024!"
          echo ""
          echo "[$(date)] ุจุฏุก ุงูุชุดุบูู..."
          
          # ุญูุธ ูุนูููุงุช ุงูุงุชุตุงู
          cat << EOF > /tmp/connection_info.txt
          =========================================
          ุงุชุตุงู VPS ุงูุฏุงุฆู
          =========================================
          IP: $CURRENT_IP
          SSH: ssh root@$CURRENT_IP
          Password: GitHubVPS2024!
          Start Time: $(date)
          Features:
          - Auto-reconnect to Tailscale
          - Auto-save every 30 minutes
          - SSH always ready
          =========================================
          EOF
          
          echo "๐พ ุชู ุญูุธ ูุนูููุงุช ุงูุงุชุตุงู ูู /tmp/connection_info.txt"
          
          # ุญููุฉ ุงูุชุดุบูู ุงูุฑุฆูุณูุฉ ุงูุจุณูุทุฉ
          current_time=0
          while [ $current_time -lt 355 ]; do  # ุฃูู ูู 360 ุจุฏูุงุฆู
            # ุงูุญุตูู ุนูู IP ุงูุญุงูู
            IP=$(tailscale ip -4 | head -n 1 2>/dev/null || echo "ุฌุงุฑู ุฅุนุงุฏุฉ ุงูุงุชุตุงู...")
            
            echo ""
            echo "========================================="
            echo "๐ [$(date)] - ุงูุฏูููุฉ $current_time"
            echo "========================================="
            echo "๐ IP ุงูุญุงูู: $IP"
            echo "๐ SSH: ssh root@$IP"
            echo "๐ Password: GitHubVPS2024!"
            
            # ุนุฑุถ ุญุงูุฉ ุงููุธุงู ูู 60 ุฏูููุฉ
            if [ $((current_time % 60)) -eq 0 ]; then
              echo ""
              echo "๐ ูุญุต ุงููุธุงู:"
              echo "   ุงูุฐุงูุฑุฉ: $(free -h | grep Mem | awk '{print $3"/"$2}') ูุณุชุฎุฏูุฉ"
              echo "   ุงูุชุฎุฒูู: $(df -h / | tail -1 | awk '{print $5}') ูุณุชุฎุฏู"
              echo "   ููุช ุงูุชุดุบูู: ุณุงุนุฉ $((current_time / 60))"
            fi
            
            # ุงูุชุญุฐูุฑ ูุจู 10 ุฏูุงุฆู ูู ุงูููุงูุฉ
            if [ $current_time -eq 350 ]; then
              echo ""
              echo "โ๏ธ  ุณูุชู ุฅุนุงุฏุฉ ุงูุชุดุบูู ุจุนุฏ 10 ุฏูุงุฆู!"
              echo "๐พ ูุชู ุญูุธ ุงูุจูุงูุงุช ุงูููุงุฆูุฉ..."
            fi
            
            # ุงูุงูุชุธุงุฑ ุฏูููุฉ ูุงุญุฏุฉ
            sleep 60
            current_time=$((current_time + 1))
          done
          
          echo ""
          echo "========================================="
          echo "๐ ุฅุนุงุฏุฉ ุชุดุบูู VPS..."
          echo "========================================="
