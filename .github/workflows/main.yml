name: Persistent-VPS
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  secure-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 0
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Restore Data
        run: |
          git config --global user.name "VPS-Bot"
          git config --global user.email "bot@vps.com"
          mkdir -p ~/my_data

      - name: Install & Configure SSH
        run: |
          sudo apt update -y
          sudo apt install -y openssh-server net-tools
          sudo systemctl enable ssh
          sudo systemctl start ssh
          
          # ุชุบููุฑ ูููุฉ ูุฑูุฑ root
          echo "root:GitHubSecure123!" | sudo chpasswd
          
          # ุฅุนุฏุงุฏุงุช SSH ุฃูุซุฑ ุฃูุงูุงู
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          
          # ุฅุถุงูุฉ ุฅุนุฏุงุฏุงุช Tailscale
          echo "AcceptEnv TAILSCALE_IP" | sudo tee -a /etc/ssh/sshd_config
          echo "AllowTcpForwarding yes" | sudo tee -a /etc/ssh/sshd_config
          
          sudo systemctl restart ssh
          
          # ุงูุชุญูู ูู ุญุงูุฉ SSH
          echo "โ SSH Status:"
          sudo systemctl status ssh --no-pager
          echo "โ SSH Listening on:"
          sudo netstat -tlnp | grep ssh

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # ุชุดุบูู Tailscale ูุน ุฅุนุฏุงุฏุงุช ูุชูุฏูุฉ
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=github-vps-${{ github.run_id }} \
            --advertise-exit-node \
            --accept-dns=false \
            --accept-routes
          
          # ุงูุญุตูู ุนูู IP ูุงูุชุญูู ููู
          tsIP=$(tailscale ip -4 | head -n 1)
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          
          # ุงูุชุญูู ูู ุญุงูุฉ Tailscale
          echo "โ Tailscale Status:"
          tailscale status
          echo "โ Tailscale IP: $tsIP"
          
          # ูุชุญ ุฌุฏุงุฑ ุงูุญูุงูุฉ ููู SSH
          sudo ufw allow 22/tcp
          echo "โ Firewall: Port 22 opened for SSH"

      - name: Configure Network & Test Connection
        run: |
          echo "๐ง Configuring network settings..."
          
          # ุชูููู IP forwarding
          sudo sysctl -w net.ipv4.ip_forward=1
          echo "net.ipv4.ip_forward=1" | sudo tee -a /etc/sysctl.conf
          
          # ุนุฑุถ ูุนูููุงุช ุงูุดุจูุฉ
          echo "๐ก Network Information:"
          ip addr show tailscale0 || echo "Tailscale interface not found"
          
          # ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ุงูุฏุงุฎูู
          echo "๐ Testing internal SSH connection..."
          if sudo systemctl is-active --quiet ssh; then
            echo "โ SSH service is running"
            
            # ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ุงููุญูู
            if timeout 5 bash -c "echo > /dev/tcp/localhost/22"; then
              echo "โ SSH is listening on localhost:22"
            else
              echo "โ SSH is NOT listening on localhost:22"
            fi
          else
            echo "โ SSH service is NOT running"
          fi

      - name: Keep VPS Alive Forever
        run: |
          echo "========================================="
          echo "๐ VPS ุฌุงูุฒ ููุงุณุชุฎุฏุงู!"
          echo "========================================="
          echo "๐ก Tailscale IP: $TAILSCALE_IP"
          echo "๐ฅ๏ธ  SSH Connection: ssh root@$TAILSCALE_IP"
          echo "๐ Password: GitHubSecure123!"
          echo "========================================="
          echo ""
          echo "๐ ุฎุทูุงุช ุงูุงุชุตุงู:"
          echo "1. ุชุฃูุฏ ูู ุฃูู ูุชุตู ุจููุณ ุดุจูุฉ Tailscale"
          echo "2. ุงุณุชุฎุฏู ุงูุฃูุฑ: ssh root@$TAILSCALE_IP"
          echo "3. ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ: GitHubSecure123!"
          echo ""
          echo "๐ ููุชุญูู ูู ุงูุงุชุตุงู:"
          echo "ping $TAILSCALE_IP"
          echo ""
          echo "[$(date)] ุจุฏุก ุงูุชุดุบูู..."
          
          # ุญููุฉ ูุง ููุงุฆูุฉ ูุน ูุนูููุงุช ุชูุตูููุฉ
          counter=1
          while true; do
            echo ""
            echo "โฐ [$(date)] VPS ูุนูู ุจุฏูู ุชููู... (ุงูุฏูููุฉ: $counter)"
            echo "๐ Tailscale IP: $TAILSCALE_IP"
            echo "๐ SSH: ssh root@$TAILSCALE_IP"
            echo "๐ Password: GitHubSecure123!"
            
            # ุงูุชุญูู ูู ุงูุฎุฏูุงุช ูู 10 ุฏูุงุฆู
            if (( counter % 10 == 0 )); then
              echo ""
              echo "๐ ูุญุต ุงูุฎุฏูุงุช:"
              echo "SSH Status: $(sudo systemctl is-active ssh)"
              echo "Tailscale Status: $(tailscale status | head -1)"
            fi
            
            sleep 60
            counter=$((counter + 1))
          done
