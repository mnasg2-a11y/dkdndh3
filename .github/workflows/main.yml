name: Persistent-VPS
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  secure-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 0
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Restore Data
        run: |
          git config --global user.name "VPS-Bot"
          git config --global user.email "bot@vps.com"
          mkdir -p ~/my_data

      - name: Install & Configure SSH
        run: |
          sudo apt update -y
          sudo apt install -y openssh-server
          sudo systemctl enable ssh
          sudo systemctl start ssh
          
          # ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± root
          echo "root:GitHubSecure123!" | sudo chpasswd
          
          # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª SSH Ø£ÙƒØ«Ø± Ø£Ù…Ø§Ù†Ø§Ù‹
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          
          # Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Tailscale
          echo "AcceptEnv TAILSCALE_IP" | sudo tee -a /etc/ssh/sshd_config
          echo "AllowTcpForwarding yes" | sudo tee -a /etc/ssh/sshd_config
          
          sudo systemctl restart ssh
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© SSH
          echo "âœ… SSH Status:"
          sudo systemctl status ssh --no-pager
          
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… ss Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† netstat
          echo "âœ… SSH Listening ports:"
          sudo ss -tlnp | grep sshd || echo "Using alternative check..."
          
          # Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù„ØªØ­Ù‚Ù‚
          echo "âœ… Checking SSH port 22:"
          sudo lsof -i:22 || echo "lsof not installed, skipping..."

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # ØªØ´ØºÙŠÙ„ Tailscale Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=github-vps-${{ github.run_id }} \
            --advertise-exit-node \
            --accept-dns=false \
            --accept-routes
          
          # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡
          tsIP=$(tailscale ip -4 | head -n 1)
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Tailscale
          echo "âœ… Tailscale Status:"
          tailscale status
          echo "âœ… Tailscale IP: $tsIP"

      - name: Configure Network & Test Connection
        run: |
          echo "ğŸ”§ Configuring network settings..."
          
          # ØªÙ…ÙƒÙŠÙ† IP forwarding
          sudo sysctl -w net.ipv4.ip_forward=1
          echo "net.ipv4.ip_forward=1" | sudo tee -a /etc/sysctl.conf
          
          # Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ©
          echo "ğŸ“¡ Network Information:"
          ip addr show tailscale0 || echo "Tailscale interface not found"
          
          # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ
          echo "ğŸ” Testing internal SSH connection..."
          if sudo systemctl is-active --quiet ssh; then
            echo "âœ… SSH service is running"
            
            # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… nc
            if command -v nc &> /dev/null; then
              if nc -z localhost 22; then
                echo "âœ… SSH is listening on localhost:22 (via nc)"
              else
                echo "âŒ SSH is NOT listening on localhost:22 (via nc)"
              fi
            else
              # Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… timeout Ùˆ/dev/tcp
              if timeout 2 bash -c "cat < /dev/null > /dev/tcp/localhost/22" 2>/dev/null; then
                echo "âœ… SSH is listening on localhost:22 (via /dev/tcp)"
              else
                echo "âŒ SSH is NOT listening on localhost:22 (via /dev/tcp)"
              fi
            fi
          else
            echo "âŒ SSH service is NOT running"
            sudo systemctl restart ssh
          fi

      - name: Keep VPS Alive Forever
        run: |
          echo "========================================="
          echo "ğŸš€ VPS Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…!"
          echo "========================================="
          echo "ğŸ“¡ Tailscale IP: $TAILSCALE_IP"
          echo "ğŸ–¥ï¸  SSH Connection: ssh root@$TAILSCALE_IP"
          echo "ğŸ”‘ Password: GitHubSecure123!"
          echo "========================================="
          echo ""
          echo "ğŸ“ Ù„Ù„Ø§ØªØµØ§Ù„ Ø§ØªØ¨Ø¹ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:"
          echo "1. ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ Ø¯Ø§Ø®Ù„ Ø´Ø¨ÙƒØ© Tailscale Ù†ÙØ³Ù‡Ø§"
          echo "2. Ø§Ø³ØªØ®Ø¯Ù…: ssh root@$TAILSCALE_IP"
          echo "3. Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù†Ø¯Ù…Ø§ ØªØ·Ù„Ø¨ Ù…Ù†Ùƒ"
          echo ""
          echo "ğŸ” Ù„ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„:"
          echo "ping $TAILSCALE_IP"
          echo ""
          echo "âš¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø§Øª:"
          echo "SSH: $(sudo systemctl is-active ssh)"
          echo "Tailscale: $(tailscale status | head -1 | awk '{print $1}')"
          echo ""
          echo "[$(date)] Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„..."
          
          # Ø­Ù„Ù‚Ø© Ù„Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ©
          counter=1
          while true; do
            echo ""
            echo "â° [$(date)] VPS Ù†Ø´Ø·... (Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©: $counter)"
            echo "ğŸ“ IP: $TAILSCALE_IP"
            echo "ğŸ”Œ SSH: ssh root@$TAILSCALE_IP"
            echo "ğŸ” Password: GitHubSecure123!"
            
            # ÙØ­Øµ Ø§Ù„Ø®Ø¯Ù…Ø§Øª ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
            if (( counter % 5 == 0 )); then
              echo ""
              echo "ğŸ”§ ÙØ­Øµ Ø³Ø±ÙŠØ¹ Ù„Ù„Ø®Ø¯Ù…Ø§Øª:"
              if sudo systemctl is-active --quiet ssh; then
                echo "âœ… SSH ÙŠØ¹Ù…Ù„"
              else
                echo "âš ï¸  Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ SSH..."
                sudo systemctl restart ssh
              fi
              
              if tailscale status &> /dev/null; then
                echo "âœ… Tailscale Ù…ØªØµÙ„"
              else
                echo "âš ï¸  Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Tailscale..."
                sudo tailscale up --reset
              fi
            fi
            
            sleep 60
            counter=$((counter + 1))
          done
